<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>GestiÃ³n de Palets</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;900&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
</head>
<body>

<header>
  <div>
    <h1>ğŸ— GestorPalet</h1>
    <span id="header-date"></span>
  </div>
  <div style="text-align:right">
    <div style="display:flex;gap:8px;align-items:center;flex-direction:column">
      <span id="usuario-actual" style="font-size:12px;color:var(--muted)"></span>
      <button class="btn-logout" onclick="cerrarSesion()">Salir</button>
    </div>
    <div style="margin-top:6px">
      <span id="total-palets-header" style="font-size:11px;color:var(--muted)"></span>
    </div>
  </div>
</header>

<!--Palets -->
<div id="screen-palets" class="screen active">
  <div id="palets-list"></div>
  <div id="empty-palets" class="empty-state" style="display:none">
    <div class="icon">ğŸ“¦</div>
    <p>No hay palets registrados.<br>TocÃ¡ el botÃ³n <strong>+</strong> para agregar uno.</p>
  </div>
</div>

<!--Resumen -->
<div id="screen-resumen" class="screen">
  <div class="stat-grid">
    <div class="stat-box">
      <div class="stat-num" id="stat-palets">0</div>
      <div class="stat-label">Palets activos</div>
    </div>
    <div class="stat-box">
      <div class="stat-num" id="stat-paquetes">0</div>
      <div class="stat-label">Total paquetes</div>
    </div>
    <div class="stat-box">
      <div class="stat-num" id="stat-tipos">0</div>
      <div class="stat-label">Tipos de producto</div>
    </div>
    <div class="stat-box">
      <div class="stat-num" id="stat-unidades">0</div>
      <div class="stat-label">Unidades totales</div>
    </div>
  </div>
  <div class="section-title">Detalle por palet</div>
  <div id="resumen-lista"></div>
  <div style="display:flex;gap:10px;margin-top:16px;flex-direction:column">
    <button class="btn btn-secondary btn-full" onclick="exportarExcel()">
      ğŸ“Š Exportar a Excel
    </button>
    <button class="btn btn-secondary btn-full" onclick="descargarJSON()">
      ğŸ’¾ Descargar JSON
    </button>
    <button class="btn btn-outline btn-full" onclick="abrirCargadorJSON()">
      ğŸ“‚ Cargar JSON
    </button>
  </div>
</div>

<!--Buscar -->
<div id="screen-buscar" class="screen">
  <div class="search-bar-wrap">
    <input type="text" id="search-input" placeholder="Buscar por nombre o cÃ³digo..." autocomplete="off" oninput="buscar(this.value)">
    <button class="search-clear" id="search-clear-btn" onclick="limpiarBusqueda()">âœ•</button>
    <span class="search-ico">ğŸ”</span>
  </div>
  <div id="search-results">
    <div class="search-hint">
      <div class="icon">ğŸ”</div>
      <p>EscribÃ­ el nombre o cÃ³digo<br>de un producto para buscarlo<br>en todos los palets.</p>
    </div>
  </div>
</div>

<!--Botones-->
<button class="fab" id="fab-btn" onclick="abrirModalPalet()">+</button>

<!-- Tab bar -->
<div class="tab-bar">
  <button class="tab-btn active" onclick="cambiarScreen('palets',this)">
    <span class="ico">ğŸ“¦</span>Palets
  </button>
  <button class="tab-btn" onclick="cambiarScreen('resumen',this)">
    <span class="ico">ğŸ“Š</span>Resumen
  </button>
  <button class="tab-btn" onclick="cambiarScreen('buscar',this)">
    <span class="ico">ğŸ”</span>Buscar
  </button>
</div>

<!--Nuevo Palet -->
<div class="modal-overlay" id="modal-palet">
  <div class="modal">
    <h2 id="modal-palet-title">Nuevo Palet</h2>
    <div class="field">
      <label>Nombre del Palet</label>
      <input type="text" id="input-palet-nombre" placeholder="Ej: Palet A, Zona 3..." autocomplete="off">
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="cerrarModalPalet()">Cancelar</button>
      <button class="btn btn-primary" onclick="guardarPalet()">Guardar</button>
    </div>
  </div>
</div>

<!--Nuevo Paquete -->
<div class="modal-overlay" id="modal-paquete">
  <div class="modal">
    <h2 id="modal-paq-title">Agregar Paquete</h2>
    <div class="field">
      <label>Nombre del Producto</label>
      <input type="text" id="input-paq-nombre" placeholder="Ej: Agua 500ml, Coca-Cola 2L..." autocomplete="off">
    </div>
    <div class="field">
      <label>CÃ³digo del Producto</label>
      <input type="text" id="input-paq-codigo" placeholder="Ej: 7790040532145" autocomplete="off" inputmode="text">
    </div>
    <div class="field">
      <label>Cantidad de paquetes</label>
      <input type="number" id="input-paq-cantidad" placeholder="Ej: 12" min="1" inputmode="numeric">
    </div>
    <div class="field">
      <label>Fecha de Vencimiento</label>
      <input type="date" id="input-paq-vencimiento">
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="cerrarModalPaquete()">Cancelar</button>
      <button class="btn btn-secondary" onclick="guardarPaquete()">Agregar</button>
    </div>
  </div>
</div>

<!--Eliminar Palet -->
<div class="modal-overlay" id="modal-del-palet">
  <div class="modal">
    <h2>âš ï¸ Eliminar Palet</h2>
    <p style="font-size:14px;color:var(--muted);line-height:1.5">
      Â¿EstÃ¡s seguro que querÃ©s eliminar este palet y todos sus paquetes? Esta acciÃ³n no se puede deshacer.
    </p>
    <div class="modal-actions" style="margin-top:20px">
      <button class="btn btn-outline" onclick="cerrarModalDelPalet()">No, cancelar</button>
      <button class="btn btn-danger" onclick="confirmarEliminarPalet()">SÃ­, eliminar</button>
    </div>
  </div>
</div>

<!-- Cargar JSON -->
<input type="file" id="file-input" accept=".json" style="display:none" onchange="cargarJSON()">

<script src="app.js"></script>

<!-- Firebase SDK (Modular) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAj-Klw0UWECBTwVq1QpMb154aWFc_nV7c",
  authDomain: "paletautheticator.firebaseapp.com",
  projectId: "paletautheticator",
  storageBucket: "paletautheticator.firebasestorage.app",
  messagingSenderId: "824517944112",
  appId: "1:824517944112:web:4e24f04594aafcd3451ef5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

window.cerrarSesion = async function() {
    if (!confirm('Â¿Cerrar sesiÃ³n?')) return;
    
    try {
        await signOut(auth);
        localStorage.removeItem('usuario-email');
        localStorage.removeItem('usuario-id');
        window.location.href = 'indexlogin.html';
    } catch (error) {
        alert('Error al cerrar sesiÃ³n: ' + error.message);
    }
}

window.addEventListener('load', () => {
    const email = localStorage.getItem('usuario-email');
    if (!email) {
        window.location.href = 'indexlogin.html';
    } else {
        document.getElementById('usuario-actual').textContent = email;
    }
});

// Verificar sesiÃ³n activa 
onAuthStateChanged(auth, (user) => {
    if (!user) {
        const email = localStorage.getItem('usuario-email');
        if (email) {
            localStorage.removeItem('usuario-email');
            localStorage.removeItem('usuario-id');
            window.location.href = 'indexlogin.html';
        }
    }
});
</script>

</body>
</html>